임베디드소프트웨어 기말과제

# ATmega128 Watch

## 1. 개발환경
- UCOS-II 를 ATmega128 (JKIT-128-1) 에 포팅하여 개발
- Compiler : WinAVR 

</br> 

## 2. 프로젝트 개요 
## 1) 주제
알람, 자동 조명, 온도 측정을 수행하는 다기능 시계

## 2) 기능
|No|기능|내용|
|--|-----|-----|
|1|현재시간|1시간 단위 시간 출력 (0:00 ~ 59:59)|
|2|알람시계|필요시 시간 설정하여 알람 출력|
|3|자동조명|실시간으로 주변 조도를 측정하여 LED에 출력|
|4|온도측정|5분 단위로 온도를 측정하여 출력|

## 3) 설계 내용
### 3-1) 동작 및 전개도
시스템을 구성하기 위해 task 3개,  Timer overflow interrupt 3개를 사용하였다. 오버플로 인터럽트로 구현된 기능은 메인 태스크와 별개로 계속해서 수행되야 하는 것들이다. 각 인터럽트에 다음과 같은 기능을 기능을 구현했다.
|ovf|기능|내용|
|--|-----|-----|
|1|메인 시간|현재 수행 테스크와 무관하게 계속해서 증가 |
|2|버저|버저 동작|
|3|조도 측정|조도 실시간으로 측정|

메인에서 동작하는 task의 기능 및 전개도는 다음과 같다
|task |기능|내용|
|--|-----|-----|
|1|메인 테스크|시간 출력 (0:00 ~ 59:59), 알람 울림, 3분 주기 확인 |
|2|알람 설정|분,초 설정 가능한 시간을 설정하여 알람 설정|
|3|온도 체크|온도 측정 및 출력|

 - 프로그램이 실행되면 먼저 시간이 출력된다. 
 - 스위치 5를 한번 누르면 알람 설정을 할 수 있는 태스크로 전환된다. 
 - 알람 설정은 4번 스위치를 눌러 초 설정 후 5번 스위치를 눌러 분으로 전환해 같은 방식으로 4번 스위치를 눌러서 설정한다 
 - LED는 실시간으로 현재 조도에 따라서 전환된다. 
 - 온도는 3분 주기로 일정시간동안 짧게 출력된다. 

![img](https://github.com/Minaminaminamima/ATmeag128_Watch/blob/main/img.png?raw=true)


### 3-2) 외부 Interrupt  
과제에서 task1과 task2 사이 전환을 위해 외부 인터럽트로 스위치5를 사용했다. flag는 현재 태스크를 기억하기 위한 변수이다. 스위치 5가 한번 눌리면 flag를 증가시키고 현재 event Flag를 클리어 한 후 현재 flag에 해당하는 event flag를 set한다. task별로 사용되는 even  flag는 다음과 같이 미리 설정해두었다.

``` C
const int shift[4] = {0x01, 0x02, 0x04};
```

태스크 내에서 사용된 OSFlagPend함수는OS_FLAG_CONSUME 옵션을 사용하지 않기 때문에 OSFlagPost가 다시 호출되기 전까지 현재 수행되는 태스크를 계속해서 수행한다.   

``` C
volatile int flag=0;
ISR(INT5_vect){
 flag++;
 _delay_ms(300);
 flag%=2;
 OSFlagPost(ground, 0xFF, OS_FLAG_CLR, &err);
 OSFlagPost(ground, shift[flag], OS_FLAG_SET, &err);
 }
 ```
 
 ### 3-3) TIMER OVF  
 현재 수행중인 태스크와 관계없이 계속해서 수행되어야 하는 동작들은 오버플로우 인터럽트로 작성하였다. background에서 계속 수행되어야 하는 동작은 
 - 메인 시간 증가
 - 버저 출력
 - 조도 측정 

총 세가지이다. 세가지 인터럽트가 동시에 같이 수행되므로 실행 순위에 차등을 두었다. 데이터시트 상으로 Program Address가 작을수록 우선순위가 높다고 확인하여 TIMER2, TIMER1, TIMER3 순으로 작성하였다. 
</br>
 
- __(1) TIMER2 OVF : 메인 시간__
  - 가장 우선순위가 높은 TIMER2 OVF는 내부 시간을 증가시키는 동작을 수행한다.  
  - 과제에서는 ATmega128의 내부 크리스탈 클락 16Mhz을 사용하였고 이론상 프리스케일러를 1024로 설정시 이0.000064초마다 TCNT2가 증가하고 TIMER2는 8비트이므로 오버플로우 인터럽트가 0~255까지 증가하면 0.000064*256 = 0.016384초 마다 인터럽트가 발생한다. 따라서 1/0.016384, 즉 61번 오버플로우 인터럽트 발생시 1초가 지났다고 할 수 있다. 
  - 그렇지만 실제 프리스케일러를 1024로 설정했을 경우 (TCCR2=0x07) 아예 동작하지 않고, 프리스케일러를 128(TCCR=0x05)로 설정했을 때 실제 1초와 맞게 동작했다. 이 경우 이론상 0.000008초마다 TCTN2가 증가, 인터럽트가 총 488번 발생해야 1초가 된다.

- __(2) TIMER1 OVF : 조도 측정__
  - OVF1는 10ms주기로 실행된다. (Prescaler=8, (16000000/ 8)/20000= 100Hz=10ms, OVF1은 16비트 이므로 (65536-20000)=35536에서 타이머 시작. TCNT1=35536) 
  - 측정된 조도에서 200 나눈 값을 기준으로 한다. 
  - 측정된 조도값이 이전 측정값과 다른 경우 메인 태스크인 task1으로 메일박스를 전송한다.  


- __(3) TIMER3 OVF : 버저__
  - 버저는 가장 사용 빈도가 적어 오버플로우 인터럽트 중 우선순위가 가장 낮은 TIMER3 OVF에 정의하였다. 
  - 이는 사용시 주기를 분주하면 동작하지 않는 문제점이 존재하여 프리스케일러를 사용하지 않았다. 
  - Timer/Counter3은 16비트를 사용하고(최대값 65536) 분주하지 않을 경우 주기는 0.0625u이므로 각 음계는65536-(((1/음계주파수)*1000000)/2)/0.0625로 계산하였다.



 ### 3-4) Task
- __(1) Task1 : 메인 테스크__
  - 메인 테스크에서는 현재 시간 출력, (알람이 설정된 경우) 알람 출력, (온도측정을 위해) 3분 주기로 확인하는 기능을 수행한다.
 
- __(2) Task2 : 알람 설정__
  - 알람 설정에서는 초, 분 단위로 알람을 설정하고 이를 메인 테스크로 보내는 기능을 수행한다. 
  - 4번 스위치 눌러 초 설정 ➜ 5번 스위치 눌러 분 설정으로 전환 ➜ 4번 스위치 눌러 분 설정 순으로 알람을 설정한다.
  - 알람 설정이 끝나면 다시 5번 스위치를 눌러 태스크를 전환한다. 
  - 정리하면 알람 설정을 위해서는 시간 설정하는 스위치, 초>분으로 전환하는 스위치 두개가 필요하다. 
    - 이를 위해 4번 스위치가 최초로 눌릴 때 5번 스위치의 인터럽트 사용을 종료하여 알람 내에서 전환 기능을 수행하도록 한 후 다시 인터럽트 기능을 수행하도록 작성하였다. 

- __(3) Task3 : 온도 측정__
  - Taak3은 Task1에서 현재시간을 확인 후 event flag를 set할 경우 수행된다. 


